\ProvidesPackage{penn_thesis_style}

\usepackage[papersize={8.5 in, 11 in}, nohead, includeheadfoot, left=1.5 in, right = 1 in, vmargin= 1 in]{geometry}
% The options above are to set the paper size (as per page 11 of the guidelines and the margins. Includefoot is to make sure that nothing
% gets printed on the margins. The statutory margins are set on page 5. 

\usepackage[doublespacing]{setspace} % Needed to set double-spacing for the main document, but needs more adhoc commands to
								% use single spacing for tables, etc.
\usepackage{calc}
\usepackage{xcolor} %for reproducible report appendices and font coloring

\usepackage[hidelinks]{hyperref}  %update with title and author in headmatter
\usepackage{bibentry} %embed citations in text
\nobibliography* %we're still doing a normal biblio


%formatting
%\usepackage{newcent}
\usepackage[final]{microtype}
%try to fix bad lines
\setlength{\emergencystretch}{1em}

%number within chapters
\makeatletter
\@addtoreset{table}{chapter}
\@addtoreset{figure}{chapter}
%\renewcommand\thetable{\thesection.\arabic{table}}
%\renewcommand\thefigure{\thesection.\arabic{table}}
\makeatother

% Commands to format the Table of Contents, List of Tables and List of Illustrations, as per the Wharton Template
\usepackage{tocloft}
\setcounter{tocdepth}{1} % Only show chapters, sections in ToC

%make dots denser
\renewcommand{\cftdotsep}{1} %default: 4.5
% Change names and format of tables
\renewcommand{\contentsname}{\hfill\large TABLE OF CONTENTS\hfill}
\renewcommand{\cfttoctitlefont}{}
\renewcommand{\cftaftertoctitle}{\hfill}
\renewcommand{\cftbeforetoctitleskip}{-21 pt} % The key value here is the -21 pts, I got to it by old fashioned measuring with a ruler....
\renewcommand{\listtablename}{LIST OF TABLES}
\renewcommand{\cftlottitlefont}{\large\hfill}
\renewcommand{\cftafterlottitle}{\hfill}
\renewcommand{\cftbeforelottitleskip}{-21 pt} % The key value here is the -21 pts, I got to it by old fashioned measuring with a ruler....
\renewcommand{\listfigurename}{LIST OF ILLUSTRATIONS}
\renewcommand{\cftloftitlefont}{\large\hfill}
\renewcommand{\cftafterloftitle}{\hfill}
\renewcommand{\cftbeforeloftitleskip}{-21 pt} % The key value here is the -21 pts, I got to it by old fashioned measuring with a ruler....

% Format chapters (dots, including the word chapter, etc.)
\renewcommand{\cftchapfont}{\upshape}
\renewcommand{\cftchapleader}{\upshape\cftdotfill{\cftdotsep}}
\renewcommand{\cftchappagefont}{\upshape}
\renewcommand{\cftchappresnum}{CHAPTER }
\renewcommand{\cftchapaftersnum}{ :}
\newlength{\mylen}   % a "scratch" length
\settowidth{\mylen}{\cftchappresnum \cftchapaftersnum} % extra space
\addtolength{\cftchapnumwidth}{\mylen} % add the extra space

% Format tables in LoT
\renewcommand{\cfttableader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cfttabpresnum}{TABLE }
\renewcommand{\cfttabaftersnum}{ :}
\newlength{\mylent}   % a "scratch" length
\settowidth{\mylent}{\cfttabpresnum} % extra space
\addtolength{\cfttabnumwidth}{\mylent} % add the extra space
\usepackage{remreset}

% Format Illustrations in LoF
\renewcommand{\cftfigleader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cftfigpresnum}{FIGURE }
\renewcommand{\cftfigaftersnum}{ :}
\newlength{\mylenf}   % a "scratch" length
\settowidth{\mylenf}{\cftfigpresnum} % extra space
\addtolength{\cftfignumwidth}{\mylenf} % add the extra space

%Format chapters in appendix
%\makeatletter
%\g@addto@macro\appendix{%
	%\addtocontents{toc}{%
		%\protect\renewcommand{\protect\cftchappresnum}{APPENDICES\space}%
	%}%
%}
%\makeatother


% Commands (more further down, at preliminary, main and appendix) to change the formatting of chapter headings
\usepackage[compact]{titlesec}
\renewcommand{\beforetitleunit}{0 pt}
\titleformat{\section}[hang]{\large\bfseries}{\thesection}{6 pt}{}
\titleformat{\subsection}[hang]{\normalsize\bfseries}{\thesubsection}{6 pt}{}
\titlespacing*{\section}{0pt}{0pt}{0pt}
\titlespacing*{\subsection}{0pt}{0pt}{0pt}

% For the signature boxes and much better looking tables
\usepackage{array} % Also for better arrays (eg matrices) in maths
\newcolumntype{P}[1]{>{\raggedright\arraybackslash}p{#1}}
\usepackage{tabularx}
\usepackage{booktabs}

\usepackage{parskip} % To allow for better management of the Dutch paragraph style
\usepackage{url} % To allow for better typing of the url in the Creative Commons part of the copyright
\usepackage[sort,compress,super,comma]{natbib} % allows the author-date citation system
\definecolor{citeColor}{gray}{0.4}
\renewcommand{\citenumfont}[1]{\textcolor{citeColor}{\scriptsize{#1}}}
%\bibpunct{(}{)}{;}{a}{,}{,} % options for natbib to yield the citation style I like
\bibpunct{}{}{\textcolor{citeColor}{\scriptsize{,}}}{s}{,}{,} % options for natbib

% Other packages that are not needed for the template, but I highly recommend (and all of your own packages go here to)
% Add them one by one to make sure they do not interfere, for instance the package subfigure clashes with this template
%\usepackage{amssymb}
%\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{graphicx}
%\usepackage{longtable}
%\usepackage{dcolumn}
%\usepackage{tabularx}
%\usepackage{rotating}
%\usepackage{xtab}
%\usepackage{paralist} % very flexible & customizable lists (eg. enumerate/itemize, etc.)
%\usepackage{verbatim}
\usepackage{subfiles} % To be better able to manage large projects by compiling the separate files included in the final document

%take care of calculations on user settings
\AtBeginDocument{
	%do some calculation based on user inputs
	\newcommand{\mytitle}{\expandafter\MakeUppercase\expandafter{\mylowertitle}} % Make sure this is in all caps 
	\newlength{\superlen}   % a "scratch" length
	\settowidth{\superlen}{\mysupervisorname, \mysupervisortitle} % Width of signature line for supervisor
	\newlength{\chairlen}   % a "scratch" length
	\settowidth{\chairlen}{\gradchairname, \gradchairtitle} % Width of signature line for supervisor
	\newlength{\maxlen}
	\setlength{\maxlen}{\maxof{\superlen}{\chairlen}}

	%set pdf title and author
	\hypersetup{pdftitle={\mylowertitle},pdfauthor={\myauthor}}
}




%preliminary chapter formatting
\newenvironment{preliminary}{
	\titleformat{\chapter}[hang]{\large\center}{\thechapter}{0 pt}{}
	\titlespacing*{\chapter}{0pt}{-33 pt}{6 pt} % The key value here is the -33 pts, I got to it by old fashioned measuring with a ruler....
	\pagestyle{plain}
	\pagenumbering{roman}
}{}

%% MAIN TEXT formatting
\newenvironment{mainMatter}{
	%\titleformat{\chapter}[display]{\large\center\bfseries\begin{minipage}[t]{\widthof{CHAPTER \thechapter: }}}{CHAPTER \thechapter: }{0 pt}{\end{minipage}\begin{minipage}[t]{\linewidth-\widthof{CHAPTER \thechapter:}}\centering}[\end{minipage}]
	\titleformat{\chapter}[hang]{\large\center\bfseries}{CHAPTER \thechapter: }{0 pt}{}
	\titlespacing*{\chapter}{0pt}{-29 pt}{6 pt} % The key value here is the -29 pts, I got to it by old fashioned measuring with a ruler....
	\newpage
	\pagenumbering{arabic}
	\pagestyle{plain} % This has to be repeated here because the lists change the style
	% Dutch style of paragraph formatting, i.e. no indents. 
	\setlength{\parskip}{10 pt} % Same as Word file
	\setlength{\parindent}{0pt}
}{
}


\usepackage[toc]{appendix} %for appendices
\renewcommand\appendixtocname{APPENDICES}
% Changing formatting for appendices
\newenvironment{appendixf}{
	\appendix
	%\titleformat{\chapter}[hang]{\large\center}{APPENDIX}{0 pt}{} % Old {APPENDIX \thechapter}{0 pt}{ : }
	\titleformat{\chapter}[hang]{\Large\center\bfseries}{APPENDIX \thechapter}{0 pt}{ : }
	%\renewcommand{\cftchappresnum}{APPENDIX }
	\titlespacing*{\chapter}{0pt}{-33 pt}{6 pt} % The key value here is the -33 pts, I got to it by old fashioned measuring with a ruler....
	\clearpage
	\begin{appendices}
	\renewcommand{\thechapter}{A.\arabic{chapter}}
	\setcounter{tocdepth}{1} % Only show chapters, sections of Appendix in ToC
	\makeatletter
		\addtocontents{toc}{%
				\begingroup
				\string\let\string\l@chapter\string\l@section
				\string\let\string\l@section\string\l@subsection
				%\let\protect\l@chapter\protect\l@section
				%\let\protect\l@section\protect\l@subsection
		}
	\makeatother
}{
	\addtocontents{toc}{\endgroup}
	\end{appendices}
}



\renewcommand\bibname{BIBLIOGRAPHY}
\newenvironment{bibliof}{
	\titleformat{\chapter}[hang]{\Large\center\bfseries}{\thechapter}{0 pt}{}
	\titlespacing*{\chapter}{0pt}{-25 pt}{6 pt} % The key value here is the -25 pts, I got to it by old fashioned measuring with a ruler....
	\singlespacing
	\phantomsection
	\addcontentsline{toc}{chapter}{\bibname}
}{}

%extra stuff that's not really important

%to get side captions on tall figures
\usepackage{floatrow}

%caption shrinking
\usepackage{caption}
\captionsetup{font={stretch=.9}}


\usepackage{listings} %for reproducible report
\usepackage{framed} %for reproducible report appendices
\usepackage{alltt} %for reproducible report appendices
\usepackage{upquote} %for reproducible report appendices

\usepackage{siunitx} %\num for numbers


\newcommand{\textBox}[1]{
	\begin{center}
	\fbox{\begin{minipage}[c]{.8\textwidth}
		#1
		\end{minipage}
	}
	\end{center}
}

\newenvironment{tightcenter}{%
	\setlength\topsep{0em}
	\setlength\parskip{0em}
	\begin{center}
}{%
	\end{center}
}


\newcommand{\citeBox}[1]{
	\singlespacing
	\vspace{-.7\baselineskip}
	\begin{center}
	\parbox{.8\textwidth}{\bibentry{#1}}
	\end{center}
	\doublespacing
	\vspace{.8\baselineskip}
}



%boxes around figures
%\usepackage{float}
%\usepackage[framemethod=tikz]{mdframed}
%\mdfdefinestyle{sidefig}{middlelinewidth=.5pt,roundcorner=8pt}
%\usepackage{xpatch}
%\makeatletter
%\xpatchcmd{\endSC@FLOAT}{\@FLOAT{\SC@captype}}{\@FLOAT{\SC@captype}\begin{mdframed}[style=sidefig]}{}{}
%\xpatchcmd{\endSC@FLOAT}{\end@FLOAT}{\end{mdframed}\end@FLOAT}{}{}
%\makeatother

%\mdfdefinestyle{myFigureBoxStyle}{backgroundcolor=yellow!10,, roundcorner=25pt,tikzsetting={draw=blue, line width=1pt}}%
%\makeatletter
%\newcommand\fs@myRoundBox{\def\@fs@cfont{\bfseries}\let\@fs@capt\floatc@plain
%\def\@fs@pre{\begin{mdframed}[style=myFigureBoxStyle]}%
%\def\@fs@mid{\vspace{\abovecaptionskip}}%
%\def\@fs@post{\end{mdframed}}\let\@fs@iftopcapt\iffalse}
%\makeatother
%\floatstyle{boxed} 
%\restylefloat{figure}

\newcommand{\makeTitlePage}{
	% TITLE PAGE
	\begin{titlepage}
		\thispagestyle{empty} % No page numbers on title page, as per Manual page 8
		\begin{center}

		\onehalfspacing

		\mytitle

		\myauthor

		A DISSERTATION

		in 

		\mydepartment 

		%For the Graduate Group in Managerial Science and Applied Economics 

		Presented to the Faculties of the University of Pennsylvania

		in 

		Partial Fulfillment of the Requirements for the

		Degree of Doctor of Philosophy

		\myyear

		\end{center}

		\vfill % Here to make sure the page is filled

		\begin{flushleft}

		Supervisor of Dissertation:\\[\signatures] % Space for signature, you can fiddle with this as you like

		\setlength\parindent{2em}
		\renewcommand{\tabcolsep}{0 pt}
		\begin{tabularx}{\maxlen}{l}
		\toprule
		\mysupervisorname, \mysupervisortitle\\ %Space between advisor and graduate chair, you can fiddle with this as you like
		\end{tabularx}
		\setlength\parindent{0em}

		Graduate Group Chairperson:\\[\signatures] % Space for signature, you can fiddle with this as you likee

		\setlength\parindent{2em}
		\begin{tabularx}{\maxlen}{l}
		\toprule
		\gradchairname, \gradchairtitle\\ %Space between advisor and graduate chair, you can fiddle with this as you like
		\end{tabularx}
		\setlength\parindent{0em}
		\singlespacing

		Dissertation Committee: % No signature necessary

		\setlength\parindent{2em}
		\mycommittee
		\setlength\parindent{0em}


		\end{flushleft}
	\end{titlepage}
	%title page should be counted
	\addtocounter{page}{1}
}


\newcommand{\makeCopyright}{
	% COPYRIGHT NOTICE (optional)

	\doublespacing

	\thispagestyle{empty} % No page number as per Manual, p. 11

	\vspace*{\fill}
	\begin{flushleft}
		\mytitle

		 \copyright \space COPYRIGHT
		 
		\myyear

		\myauthorfull\\[24 pt] % If traditional copyright then delete everything below here, but keep \end{flushleft}

		This work is licensed under the \\
		Creative Commons Attribution \\
		NonCommercial-ShareAlike 3.0 \\
		License

		To view a copy of this license, visit

		\url{http://creativecommons.org/licenses/by-nc-sa/3.0/}
	\end{flushleft}
	\pagebreak 
}

\newcommand{\makeDedication}{
	\begin{center}
	\vspace*{\fill}
	\textit{\mydedication}
	\vspace*{\fill}
	\end{center}
	\clearpage
}


\newcommand{\makeAcknowledgements}{
	\chapter*{ACKNOWLEDGEMENTS}
	%\addcontentsline{toc}{chapter}{ACKNOWLEDGEMENTS} % This is to include this section in the Table of Contents
	\myacknowledgements
	\clearpage
}


\newcommand{\makeAbstract}{
	\chapter*{ABSTRACT}
	\addcontentsline{toc}{chapter}{ABSTRACT} % This is to include this section in the Table of Contents
	\begin{center}
	\mytitle

	\myauthor

	\mysupervisorname

	\end{center}

	\myabstract
	\clearpage
}


\newcommand{\makeTablesOfContents}{
	% TABLE OF CONTENTS
	\microtypesetup{protrusion=false} % disables protrusion locally in the document
	\singlespacing


	\phantomsection %gets the hyperref numbering right
	\addcontentsline{toc}{chapter}{TABLE OF CONTENTS}
	\tableofcontents

	% LIST OF TABLES

	\clearpage
	\phantomsection %gets the hyperref numbering right
	\addcontentsline{toc}{chapter}{LIST OF TABLES}
	\listoftables
	\clearpage

	% LIST OF ILUSTRATIONS

	\phantomsection %gets the hyperref numbering right
	\addcontentsline{toc}{chapter}{LIST OF ILLUSTRATIONS}
	\listoffigures
	\microtypesetup{protrusion=true} % enables protrusion
	\doublespacing
}

\newcommand{\makePreliminary}{
	\begin{preliminary}
		\makeTitlePage{}

		%copyright should be page ii
		\makeCopyright{}

		% DEDICATION (OPTIONAL)
		\makeDedication{}

		% ACKNOWLEDGEMENT (OPTIONAL)
		\makeAcknowledgements{}

		% ABSTRACT
		\makeAbstract{}


		%TABLES OF CONTENTS TABLES AND FIGURES
		\makeTablesOfContents{}

		% PREFACE (OPTIONAL)

		%\clearpage
		%\chapter*{PREFACE (optional)}
		%\addcontentsline{toc}{chapter}{PREFACE} % This is to include this section in the Table of Contents

	\end{preliminary}
}





